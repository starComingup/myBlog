<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>系统服务 | starcoming</title>
    <meta name="generator" content="VuePress 1.8.1">
    <link rel="icon" href="logo.png">
    <meta name="description" content="Star 互联网根据地">
    
    <link rel="preload" href="/myBlog/assets/css/0.styles.fb3985b6.css" as="style"><link rel="preload" href="/myBlog/assets/js/app.50c7974d.js" as="script"><link rel="preload" href="/myBlog/assets/js/2.1d8fec94.js" as="script"><link rel="preload" href="/myBlog/assets/js/25.8fedbe1b.js" as="script"><link rel="prefetch" href="/myBlog/assets/js/10.1c777960.js"><link rel="prefetch" href="/myBlog/assets/js/11.1ecd2dbf.js"><link rel="prefetch" href="/myBlog/assets/js/12.17a1da9f.js"><link rel="prefetch" href="/myBlog/assets/js/13.8a794855.js"><link rel="prefetch" href="/myBlog/assets/js/14.2bb9244c.js"><link rel="prefetch" href="/myBlog/assets/js/15.8869bc9b.js"><link rel="prefetch" href="/myBlog/assets/js/16.0a5f97a2.js"><link rel="prefetch" href="/myBlog/assets/js/17.712f5db1.js"><link rel="prefetch" href="/myBlog/assets/js/18.76c6be13.js"><link rel="prefetch" href="/myBlog/assets/js/19.ab9162bd.js"><link rel="prefetch" href="/myBlog/assets/js/20.f68044ed.js"><link rel="prefetch" href="/myBlog/assets/js/21.211afa34.js"><link rel="prefetch" href="/myBlog/assets/js/22.e315ea7f.js"><link rel="prefetch" href="/myBlog/assets/js/23.0153ead4.js"><link rel="prefetch" href="/myBlog/assets/js/24.40c7e409.js"><link rel="prefetch" href="/myBlog/assets/js/26.3557c4bb.js"><link rel="prefetch" href="/myBlog/assets/js/27.9a28b9bc.js"><link rel="prefetch" href="/myBlog/assets/js/28.cb3a74a1.js"><link rel="prefetch" href="/myBlog/assets/js/29.684c9f19.js"><link rel="prefetch" href="/myBlog/assets/js/3.d70ceed9.js"><link rel="prefetch" href="/myBlog/assets/js/30.c2843dd3.js"><link rel="prefetch" href="/myBlog/assets/js/31.51d91a08.js"><link rel="prefetch" href="/myBlog/assets/js/4.e48a78d5.js"><link rel="prefetch" href="/myBlog/assets/js/5.d9c5b5f0.js"><link rel="prefetch" href="/myBlog/assets/js/6.1d4193ca.js"><link rel="prefetch" href="/myBlog/assets/js/7.9494dbc0.js"><link rel="prefetch" href="/myBlog/assets/js/8.7dd360ea.js"><link rel="prefetch" href="/myBlog/assets/js/9.31816ce5.js">
    <link rel="stylesheet" href="/myBlog/assets/css/0.styles.fb3985b6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myBlog/" class="home-link router-link-active"><!----> <span class="site-name">starcoming</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myBlog/Java/" class="nav-link">
  后端开发
</a></div><div class="nav-item"><a href="/myBlog/algorithm/" class="nav-link">
  算法探析
</a></div><div class="nav-item"><a href="/myBlog/sustain/" class="nav-link router-link-active">
  Linux运维
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="other Menu" class="dropdown-title"><span class="title">学到更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="other Menu" class="mobile-dropdown-title"><span class="title">学到更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myBlog/operatingsystem/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/yjs/compute_network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/yjs/compute_compose_principle/" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/security/" class="nav-link">
  网络安全
</a></li></ul></div></div> <a href="https://github.com/starComingup/myBlog.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/myBlog/Java/" class="nav-link">
  后端开发
</a></div><div class="nav-item"><a href="/myBlog/algorithm/" class="nav-link">
  算法探析
</a></div><div class="nav-item"><a href="/myBlog/sustain/" class="nav-link router-link-active">
  Linux运维
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="other Menu" class="dropdown-title"><span class="title">学到更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="other Menu" class="mobile-dropdown-title"><span class="title">学到更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myBlog/operatingsystem/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/yjs/compute_network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/yjs/compute_compose_principle/" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/security/" class="nav-link">
  网络安全
</a></li></ul></div></div> <a href="https://github.com/starComingup/myBlog.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>运维笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/myBlog/sustain/" aria-current="page" class="sidebar-link">Linux运维</a></li><li><a href="/myBlog/sustain/shell.html" class="sidebar-link">SHELL编程</a></li><li><a href="/myBlog/sustain/custom_domain&amp;https.html" class="sidebar-link">HTTPS配置</a></li><li><a href="/myBlog/sustain/ssh.html" class="sidebar-link">SSH配置</a></li><li><a href="/myBlog/sustain/system-service.html" aria-current="page" class="active sidebar-link">系统服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#什么是系统服务" class="sidebar-link">什么是系统服务</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#服务的分类" class="sidebar-link">服务的分类</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#软件包的区别" class="sidebar-link">软件包的区别</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#rpm-包服务分类" class="sidebar-link">RPM 包服务分类</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#xinetd-服务" class="sidebar-link">xinetd 服务</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#源码包服务" class="sidebar-link">源码包服务</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#如何区分rpm包服务和源码包服务" class="sidebar-link">如何区分RPM包服务和源码包服务</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#如何区分独立服务" class="sidebar-link">如何区分独立服务</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#chkconfig范例" class="sidebar-link">chkconfig范例</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#端口" class="sidebar-link">端口</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#什么是端口" class="sidebar-link">什么是端口</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#网络协议" class="sidebar-link">网络协议</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#协议端口类型" class="sidebar-link">协议端口类型</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#修改服务端口" class="sidebar-link">修改服务端口</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#查询系统中已经启动的服务" class="sidebar-link">查询系统中已经启动的服务</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#查询服务范例" class="sidebar-link">查询服务范例</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#netstat执行结果说明" class="sidebar-link">netstat执行结果说明</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#查询服务范例-2" class="sidebar-link">查询服务范例</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#socket" class="sidebar-link">Socket</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#独立服务的启动管理" class="sidebar-link">独立服务的启动管理</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#etc-init-d-启动脚本" class="sidebar-link">/etc/init.d/ 启动脚本</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#service启动服务" class="sidebar-link">service启动服务</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#独立服务的自启动管理" class="sidebar-link">独立服务的自启动管理</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#chkconfig" class="sidebar-link">chkconfig</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#chkconfig-范例" class="sidebar-link">chkconfig 范例</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#修改-etc-rc-d-rc-local-文件" class="sidebar-link">修改 /etc/rc.d/rc.local 文件</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#范例" class="sidebar-link">范例</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#etc-rc-d-rc-local-方法的优点" class="sidebar-link">/etc/rc.d/rc.local 方法的优点</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#ntsysv" class="sidebar-link">ntsysv</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#基于-xinetd-服务的启动" class="sidebar-link">基于 xinetd 服务的启动</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#使用-chkconfig-命令管理自启动" class="sidebar-link">使用 chkconfig 命令管理自启动</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#源码包服务的启动管理" class="sidebar-link">源码包服务的启动管理</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#源码包服务的自启动管理" class="sidebar-link">源码包服务的自启动管理</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#手动配置源码包自启动" class="sidebar-link">手动配置源码包自启动</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#service方案-不推荐" class="sidebar-link">service方案(不推荐)</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#chkconfig管理" class="sidebar-link">chkconfig管理</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#常见服务" class="sidebar-link">常见服务</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#什么是-daemon-与服务service" class="sidebar-link">什么是 daemon 与服务service</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#init服务" class="sidebar-link">init服务</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#执行等级" class="sidebar-link">执行等级</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#systemd的优点" class="sidebar-link">systemd的优点</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#systemd缺点" class="sidebar-link">systemd缺点</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#systemd-的配置文件目录" class="sidebar-link">systemd 的配置文件目录</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#文件的扩展名" class="sidebar-link">文件的扩展名</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#unit-类型分类说明" class="sidebar-link">unit 类型分类说明</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#通过-systemctl-管理服务" class="sidebar-link">通过 systemctl 管理服务</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#范例-1" class="sidebar-link">范例 1</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#范例-2" class="sidebar-link">范例 2</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#active状态" class="sidebar-link">Active状态</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#开机预设状态" class="sidebar-link">开机预设状态</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#观察系统上所有的服务" class="sidebar-link">观察系统上所有的服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#范例-1-2" class="sidebar-link">范例 1</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#范例-2-2" class="sidebar-link">范例 2</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#范例-3" class="sidebar-link">范例 3</a></li></ul></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#systemctl-针对-service-类型的配置" class="sidebar-link">systemctl 针对 service 类型的配置</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#配置文件相关目录简介" class="sidebar-link">配置文件相关目录简介</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#配置文件的设置项目简介" class="sidebar-link">配置文件的设置项目简介</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#配置文件组成" class="sidebar-link">配置文件组成</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#配置文件规则" class="sidebar-link">配置文件规则</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#unit-部分" class="sidebar-link">[unit]部分</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#service-部分" class="sidebar-link">[service]部分</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#install-部分" class="sidebar-link">[Install]部分</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#范例-1-3" class="sidebar-link">范例 1</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#范例2" class="sidebar-link">范例2</a></li></ul></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#systemctl-针对-timer-的配置文件" class="sidebar-link">systemctl 针对 timer 的配置文件</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#systemd-timer-优缺点" class="sidebar-link">systemd.timer 优缺点</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#任务需求" class="sidebar-link">任务需求</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#sname-timer-的设置" class="sidebar-link">sname.timer 的设置</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#使用-oncalendar-的时间" class="sidebar-link">使用 OnCalendar 的时间</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#循环运行范例" class="sidebar-link">循环运行范例</a></li><li class="sidebar-sub-header"><a href="/myBlog/sustain/system-service.html#固定日期案例" class="sidebar-link">固定日期案例</a></li></ul></li><li><a href="/myBlog/sustain/nginx-security.html" class="sidebar-link">Nginx安全风险评估以及配置策略</a></li><li><a href="/myBlog/sustain/docker-security.html" class="sidebar-link">Docker安全风险评估以及配置策略</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="系统服务"><a href="#系统服务" class="header-anchor">#</a> 系统服务</h1> <h2 id="什么是系统服务"><a href="#什么是系统服务" class="header-anchor">#</a> 什么是系统服务</h2> <p>系统服务<code>Daemon</code>就是在后台运行的程序，提供本地系统或网络功能。由于 <code>Daemon</code> 的英文原意是&quot;守护神&quot;，所以经常将系统服务称为 <code>守护进程</code>。比如 <code>apache</code> 就是实现 Web 服务的, 其服务进程是守护进程 <code>httpd</code>。</p> <blockquote><p>Linux 中就是通过启动 httpd 进程来启动 apache 服务。</p></blockquote> <h2 id="服务的分类"><a href="#服务的分类" class="header-anchor">#</a> 服务的分类</h2> <p>Linux服务按照安装方法不同可以分为 <code>RPM包服务</code>和<code>源码包服务</code>两大类。其中，RPM 包服务根据启动方法不同分为<code>独立服务</code>和<code>基于xinetd的服务</code>。</p> <h2 id="软件包的区别"><a href="#软件包的区别" class="header-anchor">#</a> 软件包的区别</h2> <p>软件包的区别是安装位置不同，<code>源码包</code>安装到手工指定的位置，不能被服务管理命令识别; 而 <code>RPM</code> 包安装到系统默认位置，可以被服务管理命令识别；所以，<code>RPM</code> 包服务和源码包服务的管理方法不同，把它们作为不同的服务分类。</p> <h2 id="rpm-包服务分类"><a href="#rpm-包服务分类" class="header-anchor">#</a> RPM 包服务分类</h2> <p>RPM包服务又可以分为两种:</p> <ul><li>独立服务: 可以自行启动，不依赖其他的管理服务, 所以响应非常快，如 <code>apache</code>、<code>vsftp</code>、<code>Samba</code> 等。</li> <li>基于xinetd的服务: 不能独立启动，客户请求时通过 <code>xinetd</code> 唤醒相应服务, 请求结束后，被唤醒的服务关闭释放资源。其优点是只要启动 xinetd 服务，而其他服务只在需要时启动，不会占用过多的资源。缺点是响应时间相对较长。</li></ul> <blockquote><p>xinetd 服务是系统的超级守护进程，作用是管理不能独立启动的服务。</p></blockquote> <h2 id="xinetd-服务"><a href="#xinetd-服务" class="header-anchor">#</a> xinetd 服务</h2> <p>系统默认是不安装 <code>xinetd</code> 守护进程，需要手工安装。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ yum  -y  install  xinetd*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="源码包服务"><a href="#源码包服务" class="header-anchor">#</a> 源码包服务</h2> <p>源码包服务其安装位置都是手工指定的，所以不能被系统服务管理命令直接识别，每种服务的启动方法都是通过不同的启动脚本，需要查看说明文档才能确定。</p> <h2 id="如何区分rpm包服务和源码包服务"><a href="#如何区分rpm包服务和源码包服务" class="header-anchor">#</a> 如何区分RPM包服务和源码包服务</h2> <p>区分RPM包服务和源码包服务的方法一般<strong>通过安装位置判断</strong>，源码包服务不能被服务管理命令直接找到的，一般会安装到 <code>/usr/local/</code> 目录中；<code>RPM</code> 包服务都会安装到系统默认位置，可以被服务管理命令 <code>service|chkconfig</code> 识别。</p> <h2 id="如何区分独立服务"><a href="#如何区分独立服务" class="header-anchor">#</a> 如何区分独立服务</h2> <p>通过 <code>chkconfig</code> 可以区分<code>独立服务</code>和基于 <code>xinetd</code> 的服务。<code>chkconfig</code> 是管理 <code>RPM</code> 包服务的自启动的命令，可以查询 <code>RPM</code> 包默认安装的所有服务。命令格式如下:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># --list: 显示RPM包安装的所有服务的自启动状态；
$ chkconfig --list [服务名]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="chkconfig范例"><a href="#chkconfig范例" class="header-anchor">#</a> chkconfig范例</h2> <p>第一列为服务名，后面 <code>0~6</code> 代表在不同的运行级别中服务是否自动启动。基于xinetd的服务不是独立的服务，没有自己的运行级别，在任何运行级别都可以自启动。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">chkconfig</span> --list
abrt-ccpp <span class="token number">0</span>:关闭 <span class="token number">1</span>:关闭 <span class="token number">2</span>:关闭 <span class="token number">3</span>:启用 <span class="token number">4</span>:关闭 <span class="token number">5</span>:启用 <span class="token number">6</span>:关闭
abrt-oops <span class="token number">0</span>:关闭 <span class="token number">1</span>:关闭 <span class="token number">2</span>:关闭 <span class="token number">3</span>:启用 <span class="token number">4</span>:关闭 <span class="token number">5</span>:启用 <span class="token number">6</span>:关闭
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
udev-post <span class="token number">0</span>:关闭 <span class="token number">1</span>:启用 <span class="token number">2</span>:启用 <span class="token number">3</span>: 启用 <span class="token number">4</span>:启用 <span class="token number">5</span>:启用 <span class="token number">6</span>:关闭
xinetd <span class="token number">0</span>:关闭 <span class="token number">1</span>:关闭 <span class="token number">2</span>:关闭 <span class="token number">3</span>:启用 <span class="token number">4</span>:启用 <span class="token number">5</span>:启用 <span class="token number">6</span>:关闭
ypbind <span class="token number">0</span>:关闭 <span class="token number">1</span>:关闭 <span class="token number">2</span>:关闭 <span class="token number">3</span>:关闭 <span class="token number">4</span>:关闭 <span class="token number">5</span>:关闭 <span class="token number">6</span>:关闭
<span class="token comment"># 基于 xinetd 的服务</span>
chargen-stream: 关闭
daytime-dgram: 关闭
echo-stream: 关闭
rsync: 关闭
tcpmux-server: 关闭
time-stream: 关闭
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="端口"><a href="#端口" class="header-anchor">#</a> 端口</h2> <p>服务是给系统提供功能的，除了有系统服务，还有网络服务。每个网络服务都有自己的端口，一般端口号都是固定的。</p> <h2 id="什么是端口"><a href="#什么是端口" class="header-anchor">#</a> 什么是端口</h2> <p>IP地址只能用来找到服务器，但是服务器上有可能搭建了多个网络服务，比如 <code>WWW</code> 服务、<code>FTP</code> 服务、<code>Mail</code> 服务，要访问哪个网络服务呢？这时就要靠端口来区分了，因为每个网络服务对应的端口都是固定的。根据 <code>IETF</code> 规定，<code>WWW</code> 服务对应的端口是 <code>80</code>，<code>FTP</code> 服务对应的端口是 <code>20</code> 和 <code>21</code>，<code>Mail</code> 服务对应的端口是 <code>25</code> 和 <code>110</code>。</p> <h2 id="网络协议"><a href="#网络协议" class="header-anchor">#</a> 网络协议</h2> <p>网络协议主要分为两大类:</p> <ul><li>TCP协议: 面向连接的可靠 <code>传输控制协议</code></li> <li>UDP协议: 面向无连接的不可靠 <code>用户数据报协议</code></li></ul> <h2 id="协议端口类型"><a href="#协议端口类型" class="header-anchor">#</a> 协议端口类型</h2> <p>上面的两种协议都支持 <code>65535</code> 个端口, 服务与端口的对应关系保存在<code>/etc/services</code>文件中。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">vim</span> /etc/services
<span class="token comment"># FTP服务端口</span>
ftp-data <span class="token number">20</span>/tcp
ftp-data <span class="token number">20</span>/udp
<span class="token function">ftp</span> <span class="token number">21</span>/tcp
<span class="token function">ftp</span> <span class="token number">21</span>/udp
fsp fspd
<span class="token comment"># 邮件发送端口</span>
smtp <span class="token number">25</span>/tcp mail
smtp <span class="token number">25</span>/udp mail
<span class="token comment"># WWW服务端口</span>
http <span class="token number">80</span>/tcp www www-http <span class="token comment">#WorldWideWeb HTTP</span>
http <span class="token number">80</span>/udp www www-http <span class="token comment">#HyperText Transfer Protocol</span>
<span class="token comment"># 邮件接收端口</span>
pop3 <span class="token number">110</span>/tcp pop-3
pop3 <span class="token number">110</span>/udp pop-3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="修改服务端口"><a href="#修改服务端口" class="header-anchor">#</a> 修改服务端口</h2> <p>网络服务的端口是能够修改的，不过一旦修改了端口，客户机就不知道服务器端口是什么，也就不能正确地获取服务了。所以，除非在实验环境下，否则不要修改端口。</p> <h2 id="查询系统中已经启动的服务"><a href="#查询系统中已经启动的服务" class="header-anchor">#</a> 查询系统中已经启动的服务</h2> <p>我们可以通过查询<code>开启的端口</code>，判断服务器开启了哪些服务, 命令格式如下。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">netstat</span> 选项

<span class="token comment"># 选项: </span>
<span class="token comment"># -a: 列出所有网络连接(已经连接的网络服务|监听网络服务|Socket套接字)</span>
<span class="token comment"># -t: 列出 TCP 数据</span>
<span class="token comment"># -u: 列出 UDF 数据</span>
<span class="token comment"># -l: 列出正在监听的网络服务(不包含已经连接的网络服务)</span>
<span class="token comment"># -n: 用端口号来显示而不用服务名；</span>
<span class="token comment"># -p: 列出该服务的进程PID；</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="查询服务范例"><a href="#查询服务范例" class="header-anchor">#</a> 查询服务范例</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">netstat</span> -tlunp
<span class="token comment"># Active Internet connections (only servers)</span>
<span class="token comment"># Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name</span>
<span class="token comment"># tcp 0 0 0.0.0.0:53575 0.0.0.0:*</span>
<span class="token comment"># LISTEN</span>
<span class="token comment"># 1200/rpc.statd</span>
<span class="token comment"># tcp 0 0 0.0.0.0:111 0.0.0.0:* LISTEN 1181/rpcbind</span>
<span class="token comment"># tcp 0 0 0.0.0.0:22 O.O.O.O:* LISTEN 1405/sshd</span>
<span class="token comment"># tcp 0 0 127.0.0.1:25 O.O.O.O:* LISTEN 1481/master</span>
<span class="token comment"># tcp 0 0 :::57454 :::* LISTEN 1200/rpc.statd</span>
<span class="token comment"># udp 0 0 0.0.0.0:58322 0.0.0.0:* 1276/avahi-daemon</span>
<span class="token comment"># udp 0 0 0.0.0.0:5353 O.O.O.O:* 1276/avahi-daemon</span>
<span class="token comment"># udp 0 0 0.0.0.0:111 O.O.O.O:* 1181/rpcbind</span>
<span class="token comment"># udp 0 0 :::111 :::* 1181/rpcbind</span>
<span class="token comment"># udp 0 0 :::47858 :::* 1200/rpc.statd</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="netstat执行结果说明"><a href="#netstat执行结果说明" class="header-anchor">#</a> netstat执行结果说明</h2> <p>netstat命令可以查看所有已经开启的端口，也就知道当前服务器上开启了哪些服务。</p> <ul><li>Proto: 数据包的协议，分为 <code>TCP</code> 和 <code>UDP</code> 数据包</li> <li>Recv-Q: 收到的数据已经在本地接收缓冲，但是还没有被进程取走的数据包数量</li> <li>Send-Q: 对方没有收到的数据包数量, 或者没有 <code>Ack回复</code> 还在本地缓冲区的数据包数量</li> <li>Local Address: 本地IP端口, 可以知道本机开启了哪些服务</li> <li>Foreign Address: 远程主机端口, 即远程主机的IP和端口</li> <li>State: 连接状态，有已经建立连接 <code>ESTABLISED</code> 和监听 <code>LISTEN</code> 两种状态</li> <li>PID/Program name: 进程ID和进程命令名称</li></ul> <h2 id="查询服务范例-2"><a href="#查询服务范例-2" class="header-anchor">#</a> 查询服务范例</h2> <p><code>netstat -an</code> 能査看更多的信息，包括<code>Socket</code>套接字。除网络服务可以绑定端口，系统网络程序或自己开发的网络程序也可以绑定端口，用端口来接收客户端的请求数据。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">netstat</span> -an
Active Internet connections <span class="token punctuation">(</span>servers and established<span class="token punctuation">)</span>
Proto Recv-Q Send-Q Local Address Foreign Address State
tcp <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0.0</span>.0.0:53575 <span class="token number">0.0</span>.0.0:* LISTEN
tcp <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0.0</span>.0.0:22 <span class="token number">0.0</span>.0.0:* LISTEN
tcp <span class="token number">0</span> <span class="token number">0</span> <span class="token number">127.0</span>.0.1:631 <span class="token number">0.0</span>.0.0:* LISTEN
tcp <span class="token number">0</span> <span class="token number">0</span> <span class="token number">127.0</span>.0.1:25 <span class="token number">0.0</span>.0.0:* LISTEN
tcp <span class="token number">0</span> <span class="token number">0</span> <span class="token number">192.168</span>.0.210:22 <span class="token number">192.168</span>.0.105:4868 ESTABLISHED
tcp <span class="token number">0</span> <span class="token number">0</span> :::57454 :::* LISTEN
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
udp <span class="token number">0</span> <span class="token number">0</span> :::932 :::*
Active UNIX domain sockets <span class="token punctuation">(</span>servers and established<span class="token punctuation">)</span>
Proto RefCnt Flags Type State I-Node Path
<span class="token comment"># Socket套接字输出</span>
Unix <span class="token number">2</span> <span class="token punctuation">[</span> ACC <span class="token punctuation">]</span> STREAM LISTENING <span class="token number">11712</span> /var/run/dbus/system_bus_socket
unix <span class="token number">2</span> <span class="token punctuation">[</span> ACC <span class="token punctuation">]</span> STREAM LISTENING <span class="token number">8450</span> @/com/ubuntu/upstart unix <span class="token number">7</span>. <span class="token punctuation">[</span> <span class="token punctuation">]</span> DGRAM <span class="token number">8651</span> @/org/kernel/udev/udevd
unix <span class="token number">2</span> <span class="token punctuation">[</span> ACC <span class="token punctuation">]</span> STREAM LISTENING <span class="token number">11942</span> @/var/run/hald/dbus-b4QVLkivf1
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="socket"><a href="#socket" class="header-anchor">#</a> Socket</h2> <p>网络服务或网络程序要想在网络中传递数据，必须利用 <code>Socket</code> 套接字绑定端口，并进行数据传递。<code>Socket</code> 套接字虽然不是网络服务，但是同样会占用端口，并在网络中传递数据。 <code>Socket</code> 套接字的输出:</p> <ul><li>Proto: 协议名称，一般是unix</li> <li>RefCnt: 连接到Socket的进程数</li> <li>Flags: 连接标识</li> <li>Type: Socket访问类型</li> <li>State: 状态(LISTENING|CONNECTED)</li> <li>I-Node: 程序文件的 i 节点号</li> <li>Path: Socke路径或相关数据输出路径</li></ul> <h2 id="独立服务的启动管理"><a href="#独立服务的启动管理" class="header-anchor">#</a> 独立服务的启动管理</h2> <p>独立服务的启动主要有两种方法。</p> <ul><li>使用 <code>/etc/init.d/</code> 目录中的启动脚本来启动独立的服务</li> <li>使用service命令来启动独立的服务</li></ul> <h2 id="etc-init-d-启动脚本"><a href="#etc-init-d-启动脚本" class="header-anchor">#</a> /etc/init.d/ 启动脚本</h2> <p>调用/etc/init.d/文件夹的脚本可以启动独立服务，一般推荐采用这种方式，命令格式如下:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ /etc/init.d/独立服务名 start<span class="token operator">|</span>stop<span class="token operator">|</span>status<span class="token operator">|</span>restart

<span class="token comment"># 选项</span>
<span class="token comment"># - start:   启动服务</span>
<span class="token comment"># - stop:    停止服务</span>
<span class="token comment"># - status:  查看服务状态</span>
<span class="token comment"># - restart: 重启动服务</span>

$ /etc/init.d/httpd start<span class="token operator">|</span>stop<span class="token operator">|</span>restart<span class="token operator">|</span>status
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="service启动服务"><a href="#service启动服务" class="header-anchor">#</a> service启动服务</h2> <p>CentOS还可以使用 <code>service</code> 命令启动独立的服务, 它仍然要调用 <code>/etc/init.d/</code> 的启动脚本来启动服务。该命令是红帽专有命令，其他发行版本不一定有这条命令，所以并不推荐使用。service 命令格式如下:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># --status -all: 列出所有独立服务的启动状态</span>
$ <span class="token function">service</span> 独立服务名 start<span class="token operator">|</span>stop<span class="token operator">|</span>restart<span class="token operator">|</span><span class="token punctuation">..</span>.

<span class="token comment"># 启动 httpd 服务</span>
$ <span class="token function">service</span> httpd start
<span class="token comment"># 查看所有独立服务的启动状态</span>
$ <span class="token function">service</span> --status -all
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>随着 <code>httpd</code> 服务的启动和停止，使用 <code>netstat -tlun</code> 命令就会看到 <code>80</code> 端口出现和消失, 说明 <code>apache</code> 绑定端口是 <code>80</code>。</p></blockquote> <h2 id="独立服务的自启动管理"><a href="#独立服务的自启动管理" class="header-anchor">#</a> 独立服务的自启动管理</h2> <p>自启动是指服务是否随着系统启动而自动启动。独立服务的自启动方法有三种如下。</p> <ul><li>使用 <code>chkconfig</code> 服务自启动管理命令</li> <li>修改 <code>/etc/rc.d/rc.local</code> 文件</li> <li>使用 <code>ntsysv</code> 管理自启动</li></ul> <h2 id="chkconfig"><a href="#chkconfig" class="header-anchor">#</a> chkconfig</h2> <p><code>chkconfig</code> 可以设置RPM包服务的自启动状态，<code>独立服务</code>和<code>基于xinetd的服务</code>的设定方法不同。命令格式如下:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ chkconfig [--level 运行级别][独立服务名][on|off]

# 选项
--level: 设定开机自启动的运行级别 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p><code>chkconfig</code>只能识别RPM包服务，不能配置源码包服务。</p></blockquote> <h2 id="chkconfig-范例"><a href="#chkconfig-范例" class="header-anchor">#</a> chkconfig 范例</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code># 所有级别都不是自启动
$ chkconfig --list | grep httpd
httpd 0:关闭 1:关 2:关 3:关 4:关 5:关 6:关
# 打开2、3、4、5级别的自启动
$ chkconfig --level 2345 httpd on
# 2、3、4、5级别开启
$ chkconfig --list | grep httpd
httpd 0:关闭 1:关 2:开 3:开 4:开 5:开 6:关
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="修改-etc-rc-d-rc-local-文件"><a href="#修改-etc-rc-d-rc-local-文件" class="header-anchor">#</a> 修改 /etc/rc.d/rc.local 文件</h2> <p>第二种方法是修改 <code>/etc/rc.d/rc.local</code> 文件，加入服务的启动命令。该文件是在系统启动时，在输入用户名和密码之前最后读取的文件，文件中的命令，都会在系统启动时调用。</p> <blockquote><p>注意: <code>/etc/rc.d/rc.loca</code>和<code>/etc/rc.local</code> 文件是软链接，修改哪个文件都可以</p></blockquote> <h2 id="范例"><a href="#范例" class="header-anchor">#</a> 范例</h2> <p>如果把某个服务的启动命令放入这个文件，该服务就会在开机时自启动。比如下面范例，修改后只要重启系统，<code>apache</code> 服务就会开机自启动了。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">vim</span> /etc/rc.d/rc.local
<span class="token comment">#!/bin/sh</span>

<span class="token comment"># 加入apache的启动命令</span>
/etc/rc.d/init.d/httpd start
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="etc-rc-d-rc-local-方法的优点"><a href="#etc-rc-d-rc-local-方法的优点" class="header-anchor">#</a> /etc/rc.d/rc.local 方法的优点</h2> <p>推荐使用该方法管理自启动，有两点好处:</p> <ul><li>遇到陌生服务器时，只要查看该文件就知道自启动了哪些服务，便于集中管理。</li> <li>源码包服务的自启动可以通过该文件实现自启动</li></ul> <blockquote><p>注意: 修改 <code>/etc/rc.d/rc.local</code> 文件的结果，不会在 <code>chkconfig --list</code>&quot; 中显示自启动的服务列表</p></blockquote> <h2 id="ntsysv"><a href="#ntsysv" class="header-anchor">#</a> ntsysv</h2> <p>第三种方法是使用 <code>ntsysv</code> 命令调用窗口模式来管理服务的自启动。命令格式如下, 执行后会和 setup 命令类似出现命令界面。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ yum <span class="token function">install</span> ntsysv
$ ntsysv <span class="token punctuation">[</span>--level 运行级别<span class="token punctuation">]</span>

<span class="token comment"># 选项: </span>
<span class="token comment"># --level 运行级别: 可以指定设定自启动的运行级别；</span>

<span class="token comment"># 只设定2、3、5级别的服务自启动</span>
$ ntsysv --level <span class="token number">235</span>
<span class="token comment"># 按默认的运行级别设置服务自启动</span>
$ ntsysv
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>注意: ntsysv 不仅可以管理独立服务，也可以管理xinetd服务, 但是不能管理源码包服务。而且它是红帽系列的专有命令，其他发行版本不一定有，所以推荐使用文件管理自启动。</p></blockquote> <h2 id="基于-xinetd-服务的启动"><a href="#基于-xinetd-服务的启动" class="header-anchor">#</a> 基于 xinetd 服务的启动</h2> <p>基于xinetd的服务修改配置文件就可以启动，配置文件在 <code>/etc/xinetd.d/</code> 目录。使用 <code>Telnet</code> 服务为例, 目前Telnet服务器默认是不安装的，需要手工安装。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 安装 telnet</span>
$ yum <span class="token function">install</span> telnet telnet-server -y
<span class="token comment"># 编辑 telnet 配置</span>
$ <span class="token function">vi</span> /etc/xinetd.d/telnet
<span class="token function">service</span> telnet <span class="token punctuation">{</span>
  flags           <span class="token operator">=</span> REUSE
  socket_type     <span class="token operator">=</span> stream
  <span class="token function">wait</span>            <span class="token operator">=</span> no
  user            <span class="token operator">=</span> root
  server          <span class="token operator">=</span> /usr/sbin/in.telnetd
  log_on_failure  <span class="token operator">+=</span> USERID
  disable         <span class="token operator">=</span> no   <span class="token comment"># no表示启动服务，yes表示停止服务</span>
<span class="token punctuation">}</span>

<span class="token comment"># 启动 xinetd 服务器</span>
$ <span class="token function">service</span> xinetd start
<span class="token comment"># 查看 xinetd服务列表</span>
$ <span class="token function">chkconfig</span> --list <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;telnet&quot;</span>
telnet:         on
<span class="token comment"># netstat -tlun|grep 23</span>
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::23                   :::*                    LISTEN     
udp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:323           <span class="token number">0.0</span>.0.0:*                          
udp6       <span class="token number">0</span>      <span class="token number">0</span> ::1:323                 :::* 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="使用-chkconfig-命令管理自启动"><a href="#使用-chkconfig-命令管理自启动" class="header-anchor">#</a> 使用 chkconfig 命令管理自启动</h2> <p>chkconfig 管理基于xinetd自启动的命令格式如下:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#基于xinetd服务没有运行级别，不用指定--level选项</span>
$ <span class="token function">chkconfig</span> 服务名 on<span class="token operator">|</span>off
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="源码包服务的启动管理"><a href="#源码包服务的启动管理" class="header-anchor">#</a> 源码包服务的启动管理</h2> <p>源码包服务的文件都会安装到指定目录，包括管理脚本程序。因此只要找到管理脚本，然后执行即可。但是每个服务的启动脚本都不一样，怎么确定？安装时的说明文档(INSTALL|README)中会明确地说明启动脚本是哪个文件。比如 apache 服务的启动脚本就是 <code>/usr/local/apache2/bin/apachectl</code>。</p> <h2 id="源码包服务的自启动管理"><a href="#源码包服务的自启动管理" class="header-anchor">#</a> 源码包服务的自启动管理</h2> <p>源码包服务的自启动管理不能依靠系统的服务管理命令，而只能把标准启动命令写入 <code>/etc/rc.d/rc.local</code> 文件中, 系统在启动过程中调用启动脚本，从而让该服务开机自启动。</p> <h2 id="手动配置源码包自启动"><a href="#手动配置源码包自启动" class="header-anchor">#</a> 手动配置源码包自启动</h2> <p>在默认情况下，源码包服务是不能被系统的服务管理命令所识别和管理的，但是可以配置设定让源码包服务被系统的服务管理命令识别。不过不推荐，因为会混淆服务类型，不利于系统维护管理。</p> <h2 id="service方案-不推荐"><a href="#service方案-不推荐" class="header-anchor">#</a> service方案(不推荐)</h2> <p><code>service</code>只是在<code>/etc/init.d/</code>目录中查找是否有服务的启动脚本，所以只要手动建立软链接把启动脚本链接到目录即可</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ln</span> -s /usr/local/apache2/bin/apachectl /etc/±nit.d/apache
<span class="token comment"># service命令可以管理 apache服务</span>
$ <span class="token function">service</span> apache restart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="chkconfig管理"><a href="#chkconfig管理" class="header-anchor">#</a> chkconfig管理</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">vi</span> /etc/init.d/apache
<span class="token comment">#!/bin/sh</span>
chkconfig: - <span class="token number">99</span> <span class="token number">10</span>                  <span class="token comment"># 格式  chkconfig:运行级别 启动顺序 关闭顺序</span>

$ <span class="token function">chkconfig</span> --add apache
$ <span class="token function">chkconfig</span> --list <span class="token operator">|</span> <span class="token function">grep</span> apache
apache    <span class="token number">0</span>:off   <span class="token number">1</span>:off   <span class="token number">2</span>:off   <span class="token number">3</span>:on   <span class="token number">4</span>:off   <span class="token number">5</span>:on   <span class="token number">6</span>:off
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>如果想让源码包服务被<code>service</code>命令所识别和管理，则只需做一个软链接把启动脚本链接到 <code>/etc/init.d/</code> 目录中即可。</li> <li>chkconfig 命令: 把启动脚本链接到 <code>/etc/init.d/</code> 目录，启动脚本加入: <code>chkconfig:运行级别 启动顺序 关闭</code>, 然后用 <code>chkconfig --add 服务名</code> 把服务加入 <code>chkconfig</code> 管理。</li></ul> <h2 id="常见服务"><a href="#常见服务" class="header-anchor">#</a> 常见服务</h2> <p>服务器维护的工作就是优化服务，即关闭不需要的服务，只开启需要的服务。因此就需要知道各种服务的功能。</p> <table><thead><tr><th>服务名称</th> <th>功能简介</th> <th>建议</th></tr></thead> <tbody><tr><td>anacron</td> <td>系统的定时任务程序</td> <td>关闭</td></tr> <tr><td>atd</td> <td>指定系统在特定时间执行某个任务，只能执行一次</td> <td>关闭</td></tr> <tr><td>bluetooth</td> <td>蓝牙设备，一般不会在服务器上启用蓝牙</td> <td>关闭</td></tr> <tr><td>cpuspeed</td> <td>调整CPU频率，当闲置时自动降低CPU频率来节省电量</td> <td>开启</td></tr> <tr><td>crond</td> <td>系统的定时任务</td> <td>开启</td></tr> <tr><td>dovecot</td> <td>邮件服务中 POP3/IMAP 服务的守护进程，主要用来接收信件。</td> <td>关闭</td></tr> <tr><td>gpm</td> <td>在字符终端 (ttyl~tty6) 中可以使用鼠标复制和粘贴，这就是这个服务的功能</td> <td>开启</td></tr> <tr><td>haldaemon</td> <td>检测和支持USB设备，如果是服务器则关闭，个人机建议开启</td> <td>关闭</td></tr> <tr><td>hidd</td> <td>蓝牙设备检测，必须启动 bluetooth 服务</td> <td>关闭</td></tr> <tr><td>httpd</td> <td>apache 服务的守护进程。如果需要启动 apache，就开启</td> <td>开启</td></tr> <tr><td>iptables</td> <td>防火墙功能，服务器的主要防护手段必须开启</td> <td>开启</td></tr> <tr><td>irda</td> <td>IrDA 提供红外线设备的通信支持</td> <td>关闭</td></tr> <tr><td>irqbalance</td> <td>支持多核处理器，让CPU自动分配系统中断提高性能，多核CPU请开启</td> <td>开启</td></tr> <tr><td>kudzu</td> <td>开机时进行硬件检测，调用相关设置软件，建议关闭</td> <td>关闭</td></tr> <tr><td>mcstrans</td> <td>SELinux 的支持服务，建议开启</td> <td>开启</td></tr> <tr><td>messagebus</td> <td>IPC进程间通信服务，在软件中交换信息，建议关闭</td> <td>关闭</td></tr> <tr><td>mysqld</td> <td>MySQL数据库服务器</td> <td>开启</td></tr> <tr><td>named</td> <td>DNS服务的守护进程，用来进行域名解析，如果是DNS服务器开启否则关闭</td> <td>关闭</td></tr> <tr><td>netfs</td> <td>自动挂载网络中的共享文件空间，比如 NFS、Samba 等</td> <td>关闭</td></tr> <tr><td>network</td> <td>提供网络设罝管理功能，建议开启</td> <td>开启</td></tr> <tr><td>nfs</td> <td>NFS服务，Linux主机之间的文件共享服务</td> <td>关闭</td></tr> <tr><td>portmap</td> <td>用在远程过程调用RPC的服务，如果没有RPC服务可以关闭</td> <td>关闭</td></tr> <tr><td>rsync</td> <td>远程数据备份守护进程</td> <td>关闭</td></tr> <tr><td>sendmail</td> <td>sendmail 邮件服务的守护进程，根据邮件服务设置</td> <td>关闭</td></tr> <tr><td>setroubleshoot</td> <td>将SELinux信息记录在日志中，建议开启</td> <td>开启</td></tr> <tr><td>smartd</td> <td>该服务用于自动检测硬盘状态，建议开启</td> <td>开启</td></tr> <tr><td>smb</td> <td>网络服务 samba 的守护进程，让Linux和Windows共享数据</td> <td>关闭</td></tr> <tr><td>squid</td> <td>代理服务的守护进程</td> <td>关闭</td></tr> <tr><td>sshd</td> <td>ssh 加密远程登录管理的服务, 远程管理必须使用</td> <td>开启</td></tr> <tr><td>syslog</td> <td>日志的守护进程</td> <td>开启</td></tr> <tr><td>vsftpd</td> <td>vsftp 服务的守护进程</td> <td>关闭</td></tr> <tr><td>xfs</td> <td>X Window字体守护进程，提供字体服务。如果不启动图形界面不用开启</td> <td>关闭</td></tr> <tr><td>xinetd</td> <td>超级守护进程。如果有依赖 xinetd 的服务，就必须开启</td> <td>开启</td></tr></tbody></table> <h2 id="什么是-daemon-与服务service"><a href="#什么是-daemon-与服务service" class="header-anchor">#</a> 什么是 daemon 与服务service</h2> <p>启动一个程序提供功能，那么这个程序就是 <code>daemon</code>，程序提供的功能就是 <code>service</code>。<code>daemon</code> 的命名方式，一般在原程序后面添加字母<code>d</code>，使用 <code>ps</code> 和 <code>top</code> 可以看到很多后缀为<code>d</code>的 <code>daemon</code> 程序。</p> <h2 id="init服务"><a href="#init服务" class="header-anchor">#</a> init服务</h2> <p>Unix系统服务管理通过 <code>init</code>进程 唤醒所有的系统所需要的服务。所有的服务启动脚本放在 <code>/etc/init.d/</code>，使用 <code>bash script</code> 脚本程序，管理命令 <code>/etc/init.d/daemon start|stop|restart|status</code>。</p> <h2 id="执行等级"><a href="#执行等级" class="header-anchor">#</a> 执行等级</h2> <p><code>init</code>根据执行等级<code>runlevel</code>来唤醒不同的服务，以进入不同的操作界面。各等级启动脚本通过 <code>/etc/rc.d/rc[0-6]/SXXdaemon</code> 连结到 <code>/etc/init.d/daemon</code>。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>0. -
1. 单人维护模式
2. -
3. 纯文本模式
4. -
5. 文字加图形界面
6. -
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="systemd的优点"><a href="#systemd的优点" class="header-anchor">#</a> systemd的优点</h2> <p>从 <code>CentOS 7.x</code> 后，改用 <code>systemd</code> 启动服务管理机制。好处如下</p> <ul><li>并行处理所有服务加速开机: init 启动脚本是依序启动，不想依赖的服务也是等待启动，<code>systemd</code> 可以让所有服务同时启动，加快系统启动速度。</li> <li>on-demand 启动方式: 只有一个 <code>systemd</code> 服务搭配 <code>systemctl</code> 指令处理，无需额外支持。</li> <li>服务相互依赖自我检查: 可以自定义服务相依性检查，比如定义B依赖A时，自动启动A服务</li> <li>根据 <code>daemon</code> 功能分类: 将所有服务定义为<code>unit</code>并且归类<code>type</code>，比如 <code>service</code>、<code>socket</code>、<code>target</code>、<code>path</code>、<code>snapshot</code>、<code>timer</code> ，方便管理员的分类与记忆。</li> <li>将多个 <code>saemons</code> 集合成群组: 将多个<code>daemons</code>功能集合成为一个 <code>target</code> 项目，执行某个 <code>target</code> 就是执行好多个 <code>daemon</code>。</li> <li>向下兼容旧的 <code>init</code> 服务脚本: 目前没有办法支持 <code>init</code> 服务脚本，只支持普通功能</li></ul> <h2 id="systemd缺点"><a href="#systemd缺点" class="header-anchor">#</a> systemd缺点</h2> <p>systemd 某些地方无法完全取代 init，如:</p> <ul><li>在 <code>runlevel</code> 的对应上，仅有 <code>1|3|4</code> 对应到 <code>systemd</code> 的某些 <code>target</code> 类型</li> <li>支持的语法有限制，无法像 <code>/etc/init.d/daemon</code> 纯脚本自定义参数</li> <li>如果启动时是通过手动启动的，<code>systemd</code> 将无法管理该服务</li> <li><code>systemd</code> 启动不支持标准IO，因此编写 <code>systemd</code> 的启动设置时，必须取消互动机制</li></ul> <h2 id="systemd-的配置文件目录"><a href="#systemd-的配置文件目录" class="header-anchor">#</a> systemd 的配置文件目录</h2> <p><code>systemd</code> 将 <code>daemon</code> 执行脚本称为服务单位 <code>unit</code>，每种服务单位按功能分为不同的类型，配置文件在以下位置。</p> <ul><li><code>/etc/systemd/system</code>: 管理员按系统需求建立的执行脚本，类似<code>/etc/rc.d/rc5.d/Sxx</code>功能，优先顺序最高</li> <li><code>/run/systemd/system</code>: 系统执行过程中所产生的服务脚本，优先顺序其次</li> <li><code>/usr/lib/systemd/system</code>: 每个服务主要启动脚本设置，类似<code>/etc/init.d/</code>中文件，优先顺序最低</li></ul> <blockquote><p>注意: 要修改某个服务启动的设置，应该修改 <code>/usr/lib/systemd/system</code> 下配置，<code>/etc/systemd/system</code>只是软链接文件</p></blockquote> <h2 id="文件的扩展名"><a href="#文件的扩展名" class="header-anchor">#</a> 文件的扩展名</h2> <p>可通过查看文件的扩展名，区分 <code>/usr/lib/systemd/system</code> 下的数据类型。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 查询 vsftpd 和 crond 服务</span>
$ ll /usr/lib/systemd/system/ <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">'(vsftpd|multi|cron)'</span>
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">318</span> Aug  <span class="token number">9</span>  <span class="token number">2019</span> crond.service
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">171</span> Oct <span class="token number">31</span>  <span class="token number">2018</span> vsftpd.service
-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">89</span> Oct <span class="token number">31</span>  <span class="token number">2018</span> vsftpd.target
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">184</span> Oct <span class="token number">31</span>  <span class="token number">2018</span> vsftpd@.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="unit-类型分类说明"><a href="#unit-类型分类说明" class="header-anchor">#</a> unit 类型分类说明</h2> <table><thead><tr><th>扩展名</th> <th>主要服务功能</th></tr></thead> <tbody><tr><td>.service</td> <td>一般系统服务类型，包括本地服务和网络服务</td></tr> <tr><td>.socket</td> <td>内部程序数据交换的 socket 服务 socket unit</td></tr> <tr><td>.target</td> <td>一群服务集合</td></tr> <tr><td>.mount、.automount</td> <td>文件系统挂载相关的服务</td></tr> <tr><td>.path</td> <td>侦测特定文件或目录类型, 比如打印服务侦测打印队列目录启动打印功能</td></tr> <tr><td>.timer</td> <td>循环执行的服务，类似 anacrontab</td></tr></tbody></table> <h2 id="通过-systemctl-管理服务"><a href="#通过-systemctl-管理服务" class="header-anchor">#</a> 通过 systemctl 管理服务</h2> <p><code>systemd</code> 启动服务的机制，主要是通过 <code>systemctl</code> 指令来处理。以前的系统需要 <code>service|chkconfig|setup|init</code> 等指令来完成。其指令格式如下:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>unit<span class="token punctuation">]</span>

commond清单: 
- start:     启动 unit
- stop:      关闭 unit
- restart:   重启 unit
- reload:    重载配置文件
- enable:    设置开机启动
- disable:   取消开机启动
- status:    显示服务信息
- is-active: 目前是否在运行
- is-enable: 是否开机启动
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="范例-1"><a href="#范例-1" class="header-anchor">#</a> 范例 1</h2> <p>看看目前 atd 这个服务的状态</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># Loaded: 开机是否启动</span>
<span class="token comment"># Active: 是否正在运行中</span>
<span class="token comment"># 最后一行: 该服务的启动信息</span>
<span class="token comment"># 登录文件格式为: 时间、信息发送主机、哪一个服务的信息、实际信息内容</span>
$ systemctl status atd.service 
* atd.service - Job spooling tools
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/atd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Tue <span class="token number">2020</span>-03-17 <span class="token number">10</span>:49:55 CST<span class="token punctuation">;</span> <span class="token number">1</span> day 5h ago
 Main PID: <span class="token number">1398</span> <span class="token punctuation">(</span>atd<span class="token punctuation">)</span>
    Tasks: <span class="token number">1</span>
   CGroup: /system.slice/atd.service
           -1398 /usr/sbin/atd -f
Mar <span class="token number">17</span> <span class="token number">10</span>:49:55 study.centos.mrcode systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started Job spooling tools.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="范例-2"><a href="#范例-2" class="header-anchor">#</a> 范例 2</h2> <p>正常关闭 atd 服务，非 kill -9</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 最后两行信息是执行 stop 后发生的事件日志信息</span>
$ systemctl stop atd.service 
$ systemctl status atd.service 
* atd.service - Job spooling tools
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/atd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: inactive <span class="token punctuation">(</span>dead<span class="token punctuation">)</span> since Wed <span class="token number">2020</span>-03-18 <span class="token number">16</span>:40:06 CST<span class="token punctuation">;</span> 13s ago
  Process: <span class="token number">1398</span> <span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/sbin/atd -f <span class="token variable">$OPTS</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">0</span>/SUCCESS<span class="token punctuation">)</span>
 Main PID: <span class="token number">1398</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">0</span>/SUCCESS<span class="token punctuation">)</span>

Mar <span class="token number">17</span> <span class="token number">10</span>:49:55 study.centos.mrcode systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started Job spooling tools.
Mar <span class="token number">18</span> <span class="token number">16</span>:40:06 study.centos.mrcode systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Stopping Job spooling tools<span class="token punctuation">..</span>.
Mar <span class="token number">18</span> <span class="token number">16</span>:40:06 study.centos.mrcode systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Stopped Job spooling tools.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="active状态"><a href="#active状态" class="header-anchor">#</a> Active状态</h2> <p>不要用 <code>kill</code> 关掉正常的服务，否则 <code>systemctl</code> 无法监控。 <code>Active</code> 状态有多个状态:</p> <ul><li>active(running): 有一个或多个程序正在运行</li> <li>active(exited): 仅执行一次就正常结束的服务，目前并没有任何程序在系统中执行。</li> <li>active(waiting): 正在执行中中，不过在在等待其他的事件才能继续处理</li> <li>inactive: 这个服务目前没有运行</li></ul> <h2 id="开机预设状态"><a href="#开机预设状态" class="header-anchor">#</a> 开机预设状态</h2> <p>开机预设状态有以下:</p> <ul><li>enabled: 开机执行</li> <li>disabled: 开机不执行</li> <li>static: 不可以自己启动, 可能会被其他的服务唤醒</li> <li>mask: 无法被启动，因为已经被强制注销, 可通过 unmask 恢复</li></ul> <h2 id="观察系统上所有的服务"><a href="#观察系统上所有的服务" class="header-anchor">#</a> 观察系统上所有的服务</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl <span class="token punctuation">[</span>command<span class="token punctuation">]</span><span class="token punctuation">[</span>--type<span class="token operator">=</span>TYPE<span class="token punctuation">]</span><span class="token punctuation">[</span>--all<span class="token punctuation">]</span>

command: 
    list-units: 按 unit 列出目前有启动的 unit。若加上 --all 才会列出没有启动的
    list-unit-files: 按 <span class="token variable"><span class="token variable">`</span>/usr/lib/systemd/system<span class="token variable">`</span></span> 内的文件，将所有文件列表说明
--type: 之前提到过的 unit type，主要有 service、socket、target 等
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="范例-1-2"><a href="#范例-1-2" class="header-anchor">#</a> 范例 1</h3> <p>列出系统上有启动的 unit, <code>systemctl</code> 不加参数，预设是 <code>list-units</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># UNIT: 项目名称</span>
<span class="token comment"># LOAD: 开机时是否会被加载</span>
<span class="token comment"># ACTIVE: 目前的状态</span>
<span class="token comment"># DESCRIPTION: 详细描述</span>
$ systemctl
UNIT                        LOAD      ACTIVE SUB       DESCRIPTION              
  proc-sys-fs-binfmt_misc.automount loaded    active running   Arbitrary Executable File Formats File System Aut<span class="token operator">&gt;</span>
  sys-devices-pci0000:00-0000:00:01.1-ata2-host1-target1:0:0-1:0:0:0-block-sr0.device loaded    active plugged  <span class="token operator">&gt;</span>
  sys-devices-pci0000:00-0000:00:03.0-virtio0-net-ens3.device loaded    active plugged   Virtio network device  <span class="token operator">&gt;</span>
  sys-devices-pci0000:00-0000:00:04.0-virtio1-block-vda-vda1.device loaded    active plugged   /sys/devices/pci<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="范例-2-2"><a href="#范例-2-2" class="header-anchor">#</a> 范例 2</h3> <p>列出所有已经安装的 unit 有哪些</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ systemctl list-unit-files 
UNIT FILE                                     STATE   
proc-sys-fs-binfmt_misc.automount             static  
dev-hugepages.mount                           static  
dev-mqueue.mount                              static 
abrt-ccpp.service                             enabled 
abrt-oops.service                             enabled 
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="范例-3"><a href="#范例-3" class="header-anchor">#</a> 范例 3</h3> <p>只列出某种类型的 unit</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 只显示 .service 类型的服务</span>
$ systemctl list-units --type<span class="token operator">=</span>service --all
  UNIT                                                  LOAD      ACTIVE   SUB     DESCRIPTION
  abrt-ccpp.service                                     loaded    active   exited  Install ABRT coredump hook
  abrt-oops.service                                     loaded    active   running ABRT kernel log watcher
  abrt-vmcore.service                                   loaded    inactive dead    Harvest vmcores <span class="token keyword">for</span> ABRT
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment"># 查找是否有 cpu 为名的服务</span>
$ systemctl list-units --type<span class="token operator">=</span>service --all <span class="token operator">|</span> <span class="token function">grep</span> cpu
  cpupower.service                                      loaded    inactive dead    Configure CPU power 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="systemctl-针对-service-类型的配置"><a href="#systemctl-针对-service-类型的配置" class="header-anchor">#</a> systemctl 针对 service 类型的配置</h2> <p>以前建立系统服务，需要在 <code>/etc/init.d/</code> 创建对应的 <code>script</code>，如今在 <code>systemd</code> 环境下，该怎么设置相关的服务启动环境？</p> <h2 id="配置文件相关目录简介"><a href="#配置文件相关目录简介" class="header-anchor">#</a> 配置文件相关目录简介</h2> <p><code>systemd</code> 的配置文件大部分在 <code>/usr/lib/systemd/system/</code> 目录内，该目录的文件主要是<strong>默认设置建议不要修改</strong>。管理员应该修改的目录是 <code>/etc/systemd/system/</code>。</p> <p>比如: 想要额外修改 vsftpd.service ，建议放到的位置如下:</p> <ul><li><code>/usr/lib/systemd/vsftpd.service</code> : 默认配置文件</li> <li><code>/etc/systemd/system/vsftp.service.d/custom.conf</code>: 建立同名以 <code>.d</code> 后缀结尾的目录，该配置会覆盖掉默认配置文件</li> <li><code>/etc/systemd/system/vsftpd.service.wants/*</code>: 设置相依服务的链接, 启动服务后启动建议服务</li> <li><code>/etc/systemd/system/vsftpd.service.requires/*</code>: 设置相依服务的链接, 启动服务前启动建议服务</li></ul> <h2 id="配置文件的设置项目简介"><a href="#配置文件的设置项目简介" class="header-anchor">#</a> 配置文件的设置项目简介</h2> <p>通过 <code>sshd.service</code> 的配置文件来讲解配置文件的内容</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">cat</span> /usr/lib/systemd/system/sshd.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>OpenSSH server daemon
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>man:sshd<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> man:sshd_config<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target sshd-keygen.service
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>sshd-keygen.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>       <span class="token comment"># 该项目于实际执行的指令参数有关</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/etc/sysconfig/sshd
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/sbin/sshd -D <span class="token variable">$OPTIONS</span>
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill -HUP <span class="token variable">$MAINPID</span>
<span class="token assign-left variable">KillMode</span><span class="token operator">=</span>process
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>42s

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>       <span class="token comment"># 此 unit 要挂载到哪个 target 下</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="配置文件组成"><a href="#配置文件组成" class="header-anchor">#</a> 配置文件组成</h2> <p>配置文件大概分为三个部分:</p> <ul><li><code>[Unit]</code>: unit说明和其他依赖 <code>daemon</code> 的设置</li> <li><code>[Service]|[Socket][Timer][Mount][Path]...</code>: 不同的 unit type 需要使用对应的设置项目，规范服务启动脚本、环境配置文件名、重新启动的方式等</li> <li><code>[Install]</code>: unit挂载的 target 位置</li></ul> <h2 id="配置文件规则"><a href="#配置文件规则" class="header-anchor">#</a> 配置文件规则</h2> <p>配置文件内有些设置规则如下:</p> <ul><li>设置项目通常是可以重复的: 可以设置两个 <code>After</code>，不过后者会取代前者，可以用 <code>After=</code> 清空该项</li> <li>设置参数是布尔类型，可以使用 <code>1|yes|true|on</code> 代表启动，<code>0|no|false|off</code> 代表关闭</li> <li>空白行、开头为 <code>#</code> 或 <code>;</code> 都表示批注信息</li></ul> <h2 id="unit-部分"><a href="#unit-部分" class="header-anchor">#</a> [unit]部分</h2> <ul><li>Description: 使用 <code>systemctl list-units</code> 时，显示的说明</li> <li>Documentation: 提供管理员能够进一步的文件查询功能</li> <li>After: 说明 <code>unit</code> 是在哪个 <code>daemon</code> 启动之后才能启动</li> <li>Before: 在什么服务启动前，启动本服务</li> <li>Rrquires: 相依性配置, <code>unit</code> 需要在哪个 <code>daemon</code> 启动后才能启动，否则不会启动</li> <li>Wants: unit 启动之后，还需要启动哪些服务</li> <li>Conflicts: 冲突服务</li></ul> <h2 id="service-部分"><a href="#service-部分" class="header-anchor">#</a> [service]部分</h2> <ul><li>Type: 启动方式，会影响到 ExecStart。一般有 simple|forking|oneshot|dbus|idle</li> <li>EnvironmentFile: 指定启动脚本的环境配置文件</li> <li>ExecStart: 实际执行此 <code>daemon</code> 的指令或脚本程序</li> <li>ExecStop: 关闭服务时所执行的指令</li> <li>ExecReload: 重新加载时所执行的指令</li> <li>Restart: 设置 <code>1</code> 时，当此 <code>daemon</code> 服务终止后，会再次启动该服务</li> <li>RemainAfterExit: 设置 <code>1</code> 时，当 <code>daemon</code> 所属的所有程序都终止后，服务会再尝试启动。</li> <li>TimeoutSec: 在启动关闭时，因为某些缘故导致无法顺利启动结束，在进入强制结束状态之前的等待时间</li> <li>KillMode: 可以是 <code>process|control-group|none</code> 中的一种</li> <li>RestartSec: 服务重新启动时的 sleep 时间，预设是 <code>100ms</code></li></ul> <h2 id="install-部分"><a href="#install-部分" class="header-anchor">#</a> [Install]部分</h2> <ul><li>WantedBy: unit挂在哪一个 target, 大部分都是 <code>*.target unit</code> 。</li> <li>Also: 相依性 enable</li> <li>Alias: 别名</li></ul> <h3 id="范例-1-3"><a href="#范例-1-3" class="header-anchor">#</a> 范例 1</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 复制启动脚本</span>
$ <span class="token builtin class-name">cd</span> /etc/systemd/system/
$ <span class="token function">cp</span> /usr/lib/systemd/system/vsftpd.service vsftpd.service
$ <span class="token function">vim</span> vsftpd.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Vsftpd <span class="token function">ftp</span> daemon
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token comment"># 重新加载配置文件</span>
$ systemctl daemon-reload
$ systemctl list-unit-files --all <span class="token operator">|</span> <span class="token function">grep</span> vsftpd
vsftpd.service                                enabled
$ systemctl status vsftpd.service
* vsftpd.service - vsftpd <span class="token function">ftp</span> daemon
   Loaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/vsftpd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="范例2"><a href="#范例2" class="header-anchor">#</a> 范例2</h3> <p>制作一个可以备份自己系统的服务，这脚本放在 <code>/backups</code> 下，内容如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">mkdir</span> /backups 
$ <span class="token function">vim</span> /backups/backup.sh
<span class="token comment">#!/bin/bash</span>

<span class="token assign-left variable">source</span><span class="token operator">=</span><span class="token string">&quot;/etc /home /root /var/lib /var/spool/{cron,at,mail}&quot;</span>
<span class="token assign-left variable">target</span><span class="token operator">=</span><span class="token string">&quot;/backups/backup-system-<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y-%m-%d<span class="token variable">)</span></span>.tar.gz&quot;</span>

<span class="token punctuation">[</span> <span class="token operator">!</span> -d /backups <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> /backups

<span class="token function">tar</span> -zcvf <span class="token variable">${target}</span> <span class="token variable">${source}</span> $<span class="token operator">&gt;</span> /backups/backup.log

$ <span class="token function">chmod</span> a+x /backups/backup.sh
$ ll /backups/backup.sh
-rwxr-xr-x. <span class="token number">1</span> root root <span class="token number">222</span> Mar <span class="token number">20</span> 09:24 /backups/backup.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>准备 <code>backup.service</code> 的启动脚本</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">vim</span> /etc/systemd/system/backup.service
<span class="token punctuation">[</span>unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>backup my server
<span class="token assign-left variable">Requires</span><span class="token operator">=</span>atd.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>simple
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/bin/bash -c <span class="token string">&quot; echo /backups/backup.sh | at now&quot;</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token comment"># 因为 ExecStart 里面用到了 at 指令，因此 atd.service 是一定需要的服务</span>

$ systemctl daemon-reload
$ systemctl start backup.service
$ systemctl status backup.service
* backup.service - backup my server
   Loaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/backup.service<span class="token punctuation">;</span> disabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: inactive <span class="token punctuation">(</span>dead<span class="token punctuation">)</span>

Mar <span class="token number">20</span> 09:30:56 study.centos.mrcode systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started backup my server.
Mar <span class="token number">20</span> 09:30:56 study.centos.mrcode bash<span class="token punctuation">[</span><span class="token number">17748</span><span class="token punctuation">]</span>: job <span class="token number">8</span> at Fri Mar <span class="token number">20</span> 09:30:00 <span class="token number">2020</span>
<span class="token comment"># 服务状态是 inactive ，因为不是驻留内存的服务，执行完成就退出</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="systemctl-针对-timer-的配置文件"><a href="#systemctl-针对-timer-的配置文件" class="header-anchor">#</a> systemctl 针对 timer 的配置文件</h2> <p>某些时候需要定期执行某项工作，或开机后执行，或是某服务启动多久后执行的需求。以前用 <code>crond</code> 处理定期任务，现在可以用 <code>timers.target</code> 可以定期处理各种任务。</p> <h2 id="systemd-timer-优缺点"><a href="#systemd-timer-优缺点" class="header-anchor">#</a> systemd.timer 优缺点</h2> <p>systemd.timer 的优势如下。</p> <ul><li>所有 <code>systemd</code> 服务产生<code>log</code>都会被记录，因此 <code>debug</code> 更清楚方便</li> <li>各项 <code>timer</code> 工作可以跟 <code>systemd</code> 的服务相结合</li> <li>各项 <code>timer</code> 工作可以跟 <code>control group</code> 结合来限制资源利用</li> <li>时间安排可以精确到毫秒的单位</li></ul> <blockquote><p>缺点: 没有 email 通知功能，也没有 anacron 一段时间内的随机取样功能</p></blockquote> <h2 id="任务需求"><a href="#任务需求" class="header-anchor">#</a> 任务需求</h2> <p><code>systemd</code> 的 <code>timer</code> 功能，必须有如下条件:</p> <ul><li>系统的 <code>timer.target</code> 必须启动</li> <li>要有 <code>sname.service</code> 的服务存在(<code>sname</code> 是自定义的名称)</li> <li>要有 <code>sname.timer</code> 的时间启动服务存在</li></ul> <h2 id="sname-timer-的设置"><a href="#sname-timer-的设置" class="header-anchor">#</a> sname.timer 的设置</h2> <p><code>[Timer]</code> 部分</p> <ul><li>OnActiveSec: 当 timers.target 启动多久后才执行该 unit</li> <li>OnBootSec: 当开机后多久之后才执行</li> <li>OnStartupSec: 当 systemd 第一次启动后多久才执行</li> <li>OnUnitActiveSec: 这个 timer 配置文件所管理的那个 unit 服务在最后一次启动后，相隔多久后再执行一次</li> <li>OnUnitInactiveSec: 这个 timer 配置文件所管理的那个 unit 服务在最后一次停止后，隔多久再执行一次</li> <li>OnCalendar: 使用实际时间(非循环时间)的方式来启动服务。时间格式后续讲解</li> <li>Unit: sname.service 与 sname.timer 中的 sname 不一致时，这里指向的 service unit</li> <li>Persistent: 使用 <code>OnCalendar</code> 设置时是否持续，默认 yes</li></ul> <h2 id="使用-oncalendar-的时间"><a href="#使用-oncalendar-的时间" class="header-anchor">#</a> 使用 OnCalendar 的时间</h2> <p>从 <code>crontab</code> 转成 <code>timer</code> 功能，需要了解时间格式如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>英文周名 YYYY-MM-DD HH:MM:SS
Thu    <span class="token number">2020</span>-03-20 <span class="token number">10</span>:00:00

<span class="token comment"># 通常英文的写法: 小单位写在前面，大单位写后面、先秒、分、小时、天等</span>
隔 <span class="token number">3</span> 小时:              3h 或 3hr 或 3hours
隔 <span class="token number">300</span> 分钟过 <span class="token number">10</span> 秒:     10s 300m 
隔 <span class="token number">5</span> 天又 <span class="token number">100</span> 分钟:      100m 5day
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="循环运行范例"><a href="#循环运行范例" class="header-anchor">#</a> 循环运行范例</h2> <p>任务需求如下:</p> <ul><li>开机后 2 小时开始执行一次 <code>backup.service</code></li> <li>自从第一次执行后，未来每两天执行一次 <code>backup.service</code></li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">vim</span> /etc/systemd/system/backup.timer
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>backup my server timer

<span class="token punctuation">[</span>Timer<span class="token punctuation">]</span>
<span class="token assign-left variable">OnBootSec</span><span class="token operator">=</span>2hrs
<span class="token assign-left variable">OnUnitActiveSec</span><span class="token operator">=</span>2days

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

$ systemctl daemon-reload 
$ systemctl <span class="token builtin class-name">enable</span> backup.timer
Created symlink from /etc/systemd/system/multi-user.target.wants/backup.timer to /etc/systemd/system/backup.timer.
$ systemctl restart backup.timer    
$ systemctl list-unit-files <span class="token operator">|</span> <span class="token function">grep</span> backup
backup.service           disabled                   <span class="token comment"># 只需要 timer 启动就 ok</span>
backup.timer             enabled

$ systemctl show timers.target 
<span class="token assign-left variable">ConditionTimestamp</span><span class="token operator">=</span>Tue <span class="token number">2020</span>-03-17 <span class="token number">10</span>:49:38 CST      <span class="token comment"># timer 这个 unit 启动的时间</span>

$ systemctl show backup.service <span class="token operator">|</span> <span class="token function">grep</span> ExecMainStartTimestamp
<span class="token assign-left variable">ExecMainStartTimestamp</span><span class="token operator">=</span>Fri <span class="token number">2020</span>-03-20 09:38:19 CST  <span class="token comment"># backup.service 上一次执行的时间</span>

$ systemctl show backup.timer <span class="token operator">|</span> <span class="token function">grep</span> NextElapseUSecMonotonic 
<span class="token assign-left variable">NextElapseUSecMonotonic</span><span class="token operator">=</span>4d 22h 48min <span class="token number">56</span>.756775s     <span class="token comment"># 下一次执行距离 timers.target 的时间</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="固定日期案例"><a href="#固定日期案例" class="header-anchor">#</a> 固定日期案例</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">vim</span> /etc/systemd/system/backup2.timer
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>backup my server timer2

<span class="token punctuation">[</span>Timer<span class="token punctuation">]</span>
<span class="token assign-left variable">OnCalendar</span><span class="token operator">=</span>Sun *-*-* 02:00:00
<span class="token assign-left variable">Persistent</span><span class="token operator">=</span>true
<span class="token assign-left variable">Unit</span><span class="token operator">=</span>backup.service     <span class="token comment"># timer 名称与原来的 service 不一致</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

$ systemctl daemon-reload
$ systemctl <span class="token builtin class-name">enable</span> backup2.timer
Created symlink from /etc/systemd/system/multi-user.target.wants/backup2.timer to /etc/systemd/system/backup2.timer.
$ systemctl restart backup2.timer 
$ systemctl list-unit-files <span class="token operator">|</span> <span class="token function">grep</span> backup
backup.service                                disabled
backup.timer                                  enabled 
backup2.timer                                 enabled 
$ systemctl show timers.target <span class="token operator">|</span> <span class="token function">grep</span> ConditionTimestamp
<span class="token assign-left variable">ConditionTimestamp</span><span class="token operator">=</span>Tue <span class="token number">2020</span>-03-17 <span class="token number">10</span>:49:38 CST
<span class="token assign-left variable">ConditionTimestampMonotonic</span><span class="token operator">=</span><span class="token number">15862087</span>
$  systemctl show backup.service <span class="token operator">|</span> <span class="token function">grep</span> ExecMainStartTimestamp
<span class="token comment"># 由于运行一次，所以没有 NextElapseUSecMonotonic 值</span>
<span class="token comment"># 时间是 Unix 标准时间, 即跟 1970-01-01 00:00:00 比较</span>
<span class="token comment"># 50 年 2个月 2周 5天 9小时才会执行，注意时间的基准值</span>
<span class="token assign-left variable">ExecMainStartTimestamp</span><span class="token operator">=</span>Fri <span class="token number">2020</span>-03-20 09:38:19 CST
<span class="token assign-left variable">ExecMainStartTimestampMonotonic</span><span class="token operator">=</span><span class="token number">254936756737</span>
$ systemctl show backup2.timer <span class="token operator">|</span> <span class="token function">grep</span> NextElapseUSecRealtime
<span class="token assign-left variable">NextElapseUSecRealtime</span><span class="token operator">=</span>50y 2month 2w 5d 9h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/starComingup/myBlog.git/edit/main/docs/sustain/system-service.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/13/2021, 9:59:43 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/myBlog/sustain/ssh.html" class="prev">
        SSH配置
      </a></span> <span class="next"><a href="/myBlog/sustain/nginx-security.html">
        Nginx安全风险评估以及配置策略
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/myBlog/assets/js/app.50c7974d.js" defer></script><script src="/myBlog/assets/js/2.1d8fec94.js" defer></script><script src="/myBlog/assets/js/25.8fedbe1b.js" defer></script>
  </body>
</html>
